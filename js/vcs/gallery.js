// Generated by CoffeeScript 1.9.3
var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  hasProp = {}.hasOwnProperty;

define(['lib/underscore', 'found/vc', 'mcs/artwork', 'mcs/artworks', 'vcs/artwork'], function(_, VC, Artwork, Artworks, ArtworkVC) {
  var Gallery;
  Gallery = (function(superClass) {
    extend(Gallery, superClass);

    function Gallery() {
      this.onArtworksChangeIsFavorite = bind(this.onArtworksChangeIsFavorite, this);
      this.onArtworksDidFetchFromServer = bind(this.onArtworksDidFetchFromServer, this);
      this.onArtworksDidFetchFromLocal = bind(this.onArtworksDidFetchFromLocal, this);
      this.onArtworksUpdate = bind(this.onArtworksUpdate, this);
      this.initializeArtworks = bind(this.initializeArtworks, this);
      this.onClickBtnFav = bind(this.onClickBtnFav, this);
      this.onClickArtwork = bind(this.onClickArtwork, this);
      return Gallery.__super__.constructor.apply(this, arguments);
    }

    Gallery.prototype.events = {
      "click [data-ui='artwork']": 'onClickArtwork',
      "click [data-ui='btnFav']": 'onClickBtnFav'
    };

    Gallery.prototype.onClickArtwork = function(e) {
      console.error('Artwork Clicked');
      e.stopPropagation();
      this.artworks.loop();
      return this.updateStateFavorite();
    };

    Gallery.prototype.onClickBtnFav = function(e) {
      console.error('BtnFav Clicked');
      console.error('e');
      e.stopPropagation();
      return this.artworks.getCurrent().toggleFavorite();
    };

    Gallery.prototype.initialize = function(option) {
      Gallery.__super__.initialize.call(this, option);
      this.artworks = new Artworks;
      this.artworks.on({
        'didFetchFromLocal': this.onArtworksDidFetchFromLocal,
        'didFetchFromServer': this.onArtworksDidFetchFromServer,
        'change:isFavorite': this.onArtworksChangeIsFavorite,
        'change:isCurrent': this.onArtworksChangeIsCurrent,
        'update': this.onArtworksUpdate
      });
      return this.render();
    };

    Gallery.prototype.initializeArtworks = function() {
      return this.artworks.fetch({
        from: "local",
        callback: (function(_this) {
          return function(rawArtworks) {
            var lack, limit;
            limit = 5;
            lack = limit - rawArtworks.length;
            if (lack < 5) {
              rawArtworks[0].isCurrent = true;
              _this.artworks.add(rawArtworks);
            }
            if (lack > 0) {
              return _this.artworks.fetch({
                from: "konachan",
                callback: function(rawArtworks) {
                  if (lack = limit) {
                    rawArtworks[0].isCurrent = true;
                  } else {
                    rawArtworks = _.first(rawArtworks, lack);
                  }
                  return _this.artworks.add(rawArtworks);
                }
              });
            }
          };
        })(this)
      });
    };

    Gallery.prototype.onArtworksUpdate = function() {
      return this.renderArtworks();
    };

    Gallery.prototype.onArtworksDidFetchFromLocal = function() {
      if (this.artworks.length > 0) {
        return this.renderArtworks();
      }
    };

    Gallery.prototype.onArtworksDidFetchFromServer = function() {
      if (this.artworks.length > 0) {
        return this.renderArtworks();
      }
    };

    Gallery.prototype.onArtworksChangeIsFavorite = function() {
      this.updateStateFavorite();
      return this.artworks.save({
        only: "fav"
      });
    };

    Gallery.prototype.update = function() {
      console.log("Gallery Rendered");
      return this.initializeArtworks();
    };

    Gallery.prototype.updateStateFavorite = function() {
      var currentArtwork;
      currentArtwork = this.artworks.getCurrent();
      if (currentArtwork.get('isFavorite')) {
        this.$el.addClass('favorite');
        return this.ui.$btnFav.text('Faved');
      } else {
        this.$el.removeClass('favorite');
        return this.ui.$btnFav.text('Fav');
      }
    };

    Gallery.prototype.renderArtworks = function() {
      var artwork, artworkVC, i, len, ref;
      this.$el.addClass('with-artworks');
      this.ui.$artworks.empty();
      if (!this.artworks) {
        console.log("No Artworks to Render");
        return;
      }
      console.log(this.artworks);
      ref = this.artworks.models;
      for (i = 0, len = ref.length; i < len; i++) {
        artwork = ref[i];
        artworkVC = new ArtworkVC({
          root: 'artworks',
          position: 'append',
          template: 'artwork',
          model: artwork
        });
      }
      return this.updateStateFavorite();
    };

    Gallery.prototype.downloadArtworks = function() {};

    return Gallery;

  })(VC);
  return Gallery;
});
